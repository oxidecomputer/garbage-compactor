From fb952a8c40fe8754c2f66adaf826680510c2e02f Mon Sep 17 00:00:00 2001
From: Oxide Computer Company <eng@oxide.computer>
Date: Fri, 24 Oct 2025 15:51:14 -0400
Subject: [PATCH 21/61] Enable memory stats on illumos

---
 src/Common/AsynchronousMetrics.cpp |  8 +++--
 src/Common/AsynchronousMetrics.h   |  2 +-
 src/Common/MemoryStatisticsOS.cpp  | 51 +++++++++++++++++++++++++++++-
 src/Common/MemoryStatisticsOS.h    |  5 ++-
 4 files changed, 60 insertions(+), 6 deletions(-)

diff --git a/src/Common/AsynchronousMetrics.cpp b/src/Common/AsynchronousMetrics.cpp
index 56e7c4f3..a4a96277 100644
--- a/src/Common/AsynchronousMetrics.cpp
+++ b/src/Common/AsynchronousMetrics.cpp
@@ -594,7 +594,7 @@ void AsynchronousMetrics::update(TimePoint update_time, bool force_update)
         "The difference in time the thread for calculation of the asynchronous metrics was scheduled to wake up and the time it was in fact, woken up."
         " A proxy-indicator of overall system latency and responsiveness." };
 
-#if defined(OS_LINUX) || defined(OS_FREEBSD)
+#if defined(OS_LINUX) || defined(OS_FREEBSD) || defined(OS_SUNOS)
     MemoryStatisticsOS::Data memory_statistics_data = memory_stat.get();
 #endif
 
@@ -625,7 +625,7 @@ void AsynchronousMetrics::update(TimePoint update_time, bool force_update)
 #endif
 
     /// Process process memory usage according to OS
-#if defined(OS_LINUX) || defined(OS_FREEBSD)
+#if defined(OS_LINUX) || defined(OS_FREEBSD) || defined(OS_SUNOS)
     {
         MemoryStatisticsOS::Data & data = memory_statistics_data;
 
@@ -635,18 +635,20 @@ void AsynchronousMetrics::update(TimePoint update_time, bool force_update)
             " The large values of this metric are totally normal, and makes only technical sense."};
         new_values["MemoryResident"] = { data.resident,
             "The amount of physical memory used by the server process, in bytes." };
-#if !defined(OS_FREEBSD)
+#if !defined(OS_FREEBSD) && !defined(OS_SUNOS)
         new_values["MemoryShared"] = { data.shared,
             "The amount of memory used by the server process, that is also shared by another processes, in bytes."
             " ClickHouse does not use shared memory, but some memory can be labeled by OS as shared for its own reasons."
             " This metric does not make a lot of sense to watch, and it exists only for completeness reasons."};
 #endif
+#if !defined(OS_SUNOS)
         new_values["MemoryCode"] = { data.code,
             "The amount of virtual memory mapped for the pages of machine code of the server process, in bytes." };
         new_values["MemoryDataAndStack"] = { data.data_and_stack,
             "The amount of virtual memory mapped for the use of stack and for the allocated memory, in bytes."
             " It is unspecified whether it includes the per-thread stacks and most of the allocated memory, that is allocated with the 'mmap' system call."
             " This metric exists only for completeness reasons. I recommend to use the `MemoryResident` metric for monitoring."};
+#endif
 
         /// We must update the value of total_memory_tracker periodically.
         /// Otherwise it might be calculated incorrectly - it can include a "drift" of memory amount.
diff --git a/src/Common/AsynchronousMetrics.h b/src/Common/AsynchronousMetrics.h
index 04d0319e..5ba77741 100644
--- a/src/Common/AsynchronousMetrics.h
+++ b/src/Common/AsynchronousMetrics.h
@@ -108,7 +108,7 @@ private:
 
     AsynchronousMetricValues values TSA_GUARDED_BY(data_mutex);
 
-#if defined(OS_LINUX) || defined(OS_FREEBSD)
+#if defined(OS_LINUX) || defined(OS_FREEBSD) || defined(OS_SUNOS)
     MemoryStatisticsOS memory_stat TSA_GUARDED_BY(data_mutex);
 #endif
 
diff --git a/src/Common/MemoryStatisticsOS.cpp b/src/Common/MemoryStatisticsOS.cpp
index 2092c679..02a8bb20 100644
--- a/src/Common/MemoryStatisticsOS.cpp
+++ b/src/Common/MemoryStatisticsOS.cpp
@@ -1,7 +1,8 @@
-#if defined(OS_LINUX) || defined(OS_FREEBSD)
+#if defined(OS_LINUX) || defined(OS_FREEBSD) || defined(OS_SUNOS)
 
 #include <sys/types.h>
 #include <sys/stat.h>
+
 #if defined(OS_FREEBSD)
 #include <sys/sysctl.h>
 #include <sys/user.h>
@@ -18,6 +19,10 @@
 #include <IO/ReadBufferFromMemory.h>
 #include <IO/ReadHelpers.h>
 
+#if defined(OS_SUNOS)
+#include <libproc.h>
+#undef C2
+#endif
 
 namespace DB
 {
@@ -156,6 +161,50 @@ MemoryStatisticsOS::Data MemoryStatisticsOS::get() const
 
 #endif
 
+#if defined(OS_SUNOS)
+
+namespace ErrorCodes
+{
+    extern const int FILE_DOESNT_EXIST;
+    extern const int CANNOT_OPEN_FILE;
+    extern const int CANNOT_READ_FROM_FILE_DESCRIPTOR;
+}
+
+MemoryStatisticsOS::MemoryStatisticsOS()
+{
+    pid_t self = ::getpid();
+    char fname[PATH_MAX];
+
+    (void) ::snprintf(fname, sizeof (fname), "/proc/%d/psinfo", self);
+    psinfo_fd = ::open(fname, O_RDONLY | O_CLOEXEC);
+    if (-1 == psinfo_fd) {
+        throwFromErrno("Cannot open file " + std::string(fname), errno == ENOENT ? ErrorCodes::FILE_DOESNT_EXIST : ErrorCodes::CANNOT_OPEN_FILE);
+    }
+}
+
+MemoryStatisticsOS::~MemoryStatisticsOS()
+{
+    ::close(psinfo_fd);
+}
+
+MemoryStatisticsOS::Data MemoryStatisticsOS::get() const
+{
+    Data data;
+    psinfo_t ps;
+    int rc;
+
+    rc = ::pread(psinfo_fd, &ps, sizeof (ps), 0);
+    if (rc < 0)
+        throwFromErrno("Cannot read from psinfo fd", ErrorCodes::CANNOT_READ_FROM_FILE_DESCRIPTOR);
+
+    data.virt = ps.pr_size * 1024;
+    data.resident = ps.pr_rssize * 1024;
+
+    return data;
+}
+
+#endif
+
 }
 
 #endif
diff --git a/src/Common/MemoryStatisticsOS.h b/src/Common/MemoryStatisticsOS.h
index 8eb6c871..ffd1e4a9 100644
--- a/src/Common/MemoryStatisticsOS.h
+++ b/src/Common/MemoryStatisticsOS.h
@@ -1,5 +1,5 @@
 #pragma once
-#if defined(OS_LINUX) || defined(OS_FREEBSD)
+#if defined(OS_LINUX) || defined(OS_FREEBSD) || defined(OS_SUNOS)
 #include <cstdint>
 #if defined(OS_FREEBSD)
 #include <unistd.h>
@@ -47,6 +47,9 @@ private:
     size_t pagesize;
     pid_t self;
 #endif
+#if defined(OS_SUNOS)
+    int psinfo_fd;
+#endif
 };
 
 }
-- 
2.50.1 (Apple Git-155)

