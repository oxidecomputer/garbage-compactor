From 6ae067bfb8c7a61a5ebbfd2348f8f4804b9f8282 Mon Sep 17 00:00:00 2001
From: Oxide Computer Company <eng@oxide.computer>
Date: Wed, 22 Nov 2023 11:48:25 +0000
Subject: [PATCH 30/52] Ensure that libunwind is linked in the final objects

---
 CMakeLists.txt                 | 4 +++-
 cmake/sunos/default_libs.cmake | 1 +
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 7c893b6..c600c4b 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -156,7 +156,9 @@ elseif(GLIBC_COMPATIBILITY)
 endif ()
 
 # Make sure the final executable has symbols exported
-set (CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -rdynamic")
+if (NOT OS_SUNOS)
+    set (CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -rdynamic")
+endif ()
 
 if (OS_DARWIN)
     # The `-all_load` flag forces loading of all symbols from all libraries,
diff --git a/cmake/sunos/default_libs.cmake b/cmake/sunos/default_libs.cmake
index 82a6113..e3cbb4d 100644
--- a/cmake/sunos/default_libs.cmake
+++ b/cmake/sunos/default_libs.cmake
@@ -7,6 +7,7 @@ endif ()
 set (BUILTINS_LIBRARY "-lgcc_s")
 
 set (DEFAULT_LIBS "${DEFAULT_LIBS} ${BUILTINS_LIBRARY} ${COVERAGE_OPTION} -lc -lm -lsocket -lnsl -lsendfile -lproc")
+set (DEFAULT_LIBS "${DEFAULT_LIBS} -Lcontrib/libunwind-cmake/ -lunwind")
 
 message(STATUS "Default libraries: ${DEFAULT_LIBS}")
 
-- 
2.40.1

