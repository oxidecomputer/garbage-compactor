From cf21f9bd2c46a73bb8e0c0641c79e8d8c4af9930 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex@cooperi.net>
Date: Wed, 7 Jun 2023 09:37:48 +1000
Subject: [PATCH 39/42] 41-sunos-libunwind.patch

---
 CMakeLists.txt                                 | 2 +-
 contrib/libunwind-cmake/CMakeLists.txt         | 6 +++++-
 contrib/libunwind/src/AddressSpace.hpp         | 4 ++++
 contrib/libunwind/src/UnwindRegistersRestore.S | 4 ++--
 contrib/libunwind/src/UnwindRegistersSave.S    | 4 ++--
 contrib/libunwind/src/libunwind.cpp            | 3 +--
 6 files changed, 15 insertions(+), 8 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 7e9765131e..59197ebe47 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -287,7 +287,7 @@ include(cmake/cpu_features.cmake)
 # Asynchronous unwind tables are needed for Query Profiler.
 # They are already by default on some platforms but possibly not on all platforms.
 # Enable it explicitly.
-set (COMPILER_FLAGS "${COMPILER_FLAGS} -fasynchronous-unwind-tables")
+#set (COMPILER_FLAGS "${COMPILER_FLAGS} -fasynchronous-unwind-tables")
 
 # Reproducible builds.
 if (CMAKE_BUILD_TYPE_UC STREQUAL "DEBUG")
diff --git a/contrib/libunwind-cmake/CMakeLists.txt b/contrib/libunwind-cmake/CMakeLists.txt
index 155853a0bc..86152aebcf 100644
--- a/contrib/libunwind-cmake/CMakeLists.txt
+++ b/contrib/libunwind-cmake/CMakeLists.txt
@@ -42,9 +42,13 @@ add_library(unwind ${LIBUNWIND_SOURCES})
 set_target_properties(unwind PROPERTIES FOLDER "contrib/libunwind-cmake")
 
 target_include_directories(unwind SYSTEM BEFORE PUBLIC $<BUILD_INTERFACE:${LIBUNWIND_SOURCE_DIR}/include>)
-target_compile_definitions(unwind PRIVATE -D_LIBUNWIND_NO_HEAP=1 -D_DEBUG -D_LIBUNWIND_IS_NATIVE_ONLY)
+target_compile_definitions(unwind PRIVATE -D_LIBUNWIND_NO_HEAP=1 -D_DEBUG -D_LIBUNWIND_IS_NATIVE_ONLY -D_REENTRANT -D__EXTENSIONS__)
 target_compile_options(unwind PRIVATE -fno-exceptions -funwind-tables -fno-sanitize=all $<$<COMPILE_LANGUAGE:CXX>:-nostdinc++ -fno-rtti>)
 
+if (OS_SUNOS)
+    target_compile_definitions(unwind PRIVATE -D_LIBUNWIND_USE_DL_ITERATE_PHDR)
+endif()
+
 check_c_compiler_flag(-Wunused-but-set-variable HAVE_WARNING_UNUSED_BUT_SET_VARIABLE)
 if (HAVE_WARNING_UNUSED_BUT_SET_VARIABLE)
     target_compile_options(unwind PRIVATE -Wno-unused-but-set-variable)
diff --git a/contrib/libunwind/src/AddressSpace.hpp b/contrib/libunwind/src/AddressSpace.hpp
index b538ef7645..8d10e1b3e3 100644
--- a/contrib/libunwind/src/AddressSpace.hpp
+++ b/contrib/libunwind/src/AddressSpace.hpp
@@ -426,7 +426,11 @@ static bool checkAddrInSegment(const Elf_Phdr *phdr, size_t image_base,
 static bool checkForUnwindInfoSegment(const Elf_Phdr *phdr, size_t image_base,
                                       dl_iterate_cb_data *cbdata) {
 #if defined(_LIBUNWIND_SUPPORT_DWARF_INDEX)
+#if defined(PT_SUNW_UNWIND)
+  if (phdr->p_type == PT_SUNW_EH_FRAME || phdr->p_type == PT_SUNW_UNWIND) {
+#else
   if (phdr->p_type == PT_GNU_EH_FRAME) {
+#endif
     EHHeaderParser<LocalAddressSpace>::EHHeaderInfo hdrInfo;
     uintptr_t eh_frame_hdr_start = image_base + phdr->p_vaddr;
     cbdata->sects->dwarf_index_section = eh_frame_hdr_start;
diff --git a/contrib/libunwind/src/UnwindRegistersRestore.S b/contrib/libunwind/src/UnwindRegistersRestore.S
index eeb6453496..82825ee35b 100644
--- a/contrib/libunwind/src/UnwindRegistersRestore.S
+++ b/contrib/libunwind/src/UnwindRegistersRestore.S
@@ -14,7 +14,7 @@
   .text
 #endif
 
-#if !defined(__USING_SJLJ_EXCEPTIONS__)
+//#if !defined(__USING_SJLJ_EXCEPTIONS__)
 
 #if defined(__i386__)
 DEFINE_LIBUNWIND_FUNCTION(__libunwind_Registers_x86_jumpto)
@@ -1291,7 +1291,7 @@ DEFINE_LIBUNWIND_FUNCTION(_ZN9libunwind15Registers_s390x6jumptoEv)
 
 #endif
 
-#endif /* !defined(__USING_SJLJ_EXCEPTIONS__) */
+//#endif /* !defined(__USING_SJLJ_EXCEPTIONS__) */
 
 NO_EXEC_STACK_DIRECTIVE
 
diff --git a/contrib/libunwind/src/UnwindRegistersSave.S b/contrib/libunwind/src/UnwindRegistersSave.S
index f57dd637dd..68bbf5533c 100644
--- a/contrib/libunwind/src/UnwindRegistersSave.S
+++ b/contrib/libunwind/src/UnwindRegistersSave.S
@@ -14,7 +14,7 @@
     .text
 #endif
 
-#if !defined(__USING_SJLJ_EXCEPTIONS__)
+//#if !defined(__USING_SJLJ_EXCEPTIONS__)
 
 #if defined(__i386__)
 
@@ -1226,6 +1226,6 @@ DEFINE_LIBUNWIND_FUNCTION(__unw_getcontext)
 
   WEAK_ALIAS(__unw_getcontext, unw_getcontext)
 
-#endif /* !defined(__USING_SJLJ_EXCEPTIONS__) */
+//#endif /* !defined(__USING_SJLJ_EXCEPTIONS__) */
 
 NO_EXEC_STACK_DIRECTIVE
diff --git a/contrib/libunwind/src/libunwind.cpp b/contrib/libunwind/src/libunwind.cpp
index ca7d9a01e6..66e9dc7b76 100644
--- a/contrib/libunwind/src/libunwind.cpp
+++ b/contrib/libunwind/src/libunwind.cpp
@@ -26,7 +26,7 @@
 #include <sanitizer/asan_interface.h>
 #endif
 
-#if !defined(__USING_SJLJ_EXCEPTIONS__)
+//#if !defined(__USING_SJLJ_EXCEPTIONS__)
 #include "AddressSpace.hpp"
 #include "UnwindCursor.hpp"
 
@@ -336,7 +336,6 @@ void __unw_remove_dynamic_eh_frame_section(unw_word_t eh_frame_start) {
 }
 
 #endif // defined(_LIBUNWIND_SUPPORT_DWARF_UNWIND)
-#endif // !defined(__USING_SJLJ_EXCEPTIONS__)
 
 int unw_backtrace(void **buffer, int size) {
   unw_context_t context;
-- 
2.40.1

