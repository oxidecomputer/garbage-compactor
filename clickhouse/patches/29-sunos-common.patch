From 0a73c81a5e9d240e7310f10d7cc32805ad42f46f Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex@cooperi.net>
Date: Tue, 30 May 2023 17:19:04 +1000
Subject: [PATCH 27/42] 29-sunos-common.patch

diff -wpruN --no-dereference '--exclude=*.orig' a~/src/Common/QueryProfiler.cpp a/src/Common/QueryProfiler.cpp
--- a~/src/Common/QueryProfiler.cpp	1970-01-01 00:00:00
+++ a/src/Common/QueryProfiler.cpp	1970-01-01 00:00:00
@@ -216,7 +216,7 @@ QueryProfilerBase<ProfilerImpl>::QueryPr
     UNUSED(pause_signal);
 
     throw Exception(ErrorCodes::NOT_IMPLEMENTED, "QueryProfiler cannot work on OSX");
-#else
+#elif defined(SIGEV_THREAD_ID)
     /// Sanity check.
     if (!hasPHDRCache())
         throw Exception(ErrorCodes::NOT_IMPLEMENTED, "QueryProfiler cannot be used without PHDR cache, that is not available for TSan build");
@@ -245,6 +245,8 @@ QueryProfilerBase<ProfilerImpl>::QueryPr
         timer.cleanup();
         throw;
     }
+#else
+    throw Exception(ErrorCodes::CANNOT_CREATE_TIMER, "OS does not support QueryProfiler");
 #endif
 }
 
diff -wpruN --no-dereference '--exclude=*.orig' a~/src/Common/waitForPid.cpp a/src/Common/waitForPid.cpp
--- a~/src/Common/waitForPid.cpp	1970-01-01 00:00:00
+++ a/src/Common/waitForPid.cpp	1970-01-01 00:00:00
@@ -153,6 +153,28 @@ static PollPidResult pollPid(pid_t pid,
 
     return result;
 }
+#elif defined(__sun)
+#include <libproc.h>
+
+namespace DB
+{
+
+static PollPidResult pollPid(pid_t pid, int timeout_in_ms)
+{
+    PollPidResult result = PollPidResult::FAILED;
+    int rc, perr;
+    struct ps_prochandle *hdl;
+    hdl = Pgrab(pid, PGRAB_RETAIN | PGRAB_FORCE | PGRAB_NOSTOP, &perr);
+    if (hdl == NULL)
+        return PollPidResult::FAILED;
+    rc = Pstopstatus(hdl, PCWSTOP, timeout_in_ms);
+    if (rc < 0 && errno == ENOENT)
+        result = PollPidResult::RESTART;
+    if (rc == 0 && Pstate(hdl) != PS_RUN)
+        result = PollPidResult::RESTART;
+    Pfree(hdl);
+    return result;
+}
 #else
     #error "Unsupported OS type"
 #endif
