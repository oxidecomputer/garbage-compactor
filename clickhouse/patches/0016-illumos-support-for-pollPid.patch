From 80fac403ec2db8de3406dbefd53857a6ed733129 Mon Sep 17 00:00:00 2001
From: Oxide Computer Company <eng@oxide.computer>
Date: Wed, 22 Nov 2023 12:39:46 +0000
Subject: [PATCH 16/52] illumos support for pollPid

---
 src/Common/waitForPid.cpp | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/src/Common/waitForPid.cpp b/src/Common/waitForPid.cpp
index 05e90f9..0b90102 100644
--- a/src/Common/waitForPid.cpp
+++ b/src/Common/waitForPid.cpp
@@ -153,6 +153,28 @@ static PollPidResult pollPid(pid_t pid, int timeout_in_ms)
 
     return result;
 }
+#elif defined(__sun)
+#include <libproc.h>
+
+namespace DB
+{
+
+static PollPidResult pollPid(pid_t pid, int timeout_in_ms)
+{
+    PollPidResult result = PollPidResult::FAILED;
+    int rc, perr;
+    struct ps_prochandle *hdl;
+    hdl = Pgrab(pid, PGRAB_RETAIN | PGRAB_FORCE | PGRAB_NOSTOP, &perr);
+    if (hdl == NULL)
+        return PollPidResult::FAILED;
+    rc = Pstopstatus(hdl, PCWSTOP, timeout_in_ms);
+    if (rc < 0 && errno == ENOENT)
+        result = PollPidResult::RESTART;
+    if (rc == 0 && Pstate(hdl) != PS_RUN)
+        result = PollPidResult::RESTART;
+    Pfree(hdl);
+    return result;
+}
 #else
     #error "Unsupported OS type"
 #endif
-- 
2.40.1

