From df213012dd6a7f0905154b4de6139f453454d152 Mon Sep 17 00:00:00 2001
From: Oxide Computer Company <eng@oxide.computer>
Date: Wed, 22 Nov 2023 11:46:39 +0000
Subject: [PATCH 42/52] contrib/llvm-project: Enable xlocale for illumos

---
 contrib/llvm-project-cmake/CMakeLists.txt                   | 6 ++++++
 contrib/llvm-project/libcxx/src/support/solaris/xlocale.cpp | 3 ++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/contrib/llvm-project-cmake/CMakeLists.txt b/contrib/llvm-project-cmake/CMakeLists.txt
index fe6cffd..412fe77 100644
--- a/contrib/llvm-project-cmake/CMakeLists.txt
+++ b/contrib/llvm-project-cmake/CMakeLists.txt
@@ -64,6 +64,12 @@ set (REQUIRED_LLVM_LIBRARIES
 #     list(APPEND REQUIRED_LLVM_LIBRARIES LLVMAArch64Info LLVMAArch64Desc LLVMAArch64CodeGen)
 # endif ()
 
+if (OS_SUNOS)
+    set (SRCS ${SRCS}
+        "${LIBCXX_SOURCE_DIR}/src/support/solaris/xlocale.cpp"
+    )
+endif()
+
 set (CMAKE_INSTALL_RPATH "ON") # Do not adjust RPATH in llvm, since then it will not be able to find libcxx/libcxxabi/libunwind
 set (LLVM_COMPILER_CHECKED 1 CACHE INTERNAL "") # Skip internal compiler selection
 set (LLVM_ENABLE_EH 1 CACHE INTERNAL "") # With exception handling
diff --git a/contrib/llvm-project/libcxx/src/support/solaris/xlocale.cpp b/contrib/llvm-project/libcxx/src/support/solaris/xlocale.cpp
index d25adcd..2e13391 100644
--- a/contrib/llvm-project/libcxx/src/support/solaris/xlocale.cpp
+++ b/contrib/llvm-project/libcxx/src/support/solaris/xlocale.cpp
@@ -11,7 +11,8 @@
 #include "__support/solaris/xlocale.h"
 #include <stdarg.h>
 #include <stdio.h>
-#include <sys/localedef.h>
+#include <ctype.h>
+#include <wchar.h>
 
 extern "C" {
 
-- 
2.40.1

